<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf8">
    <title>丸と†罰†</title>
    <link rel="stylesheet" href="mystyle.css">
</head>
<body>
    <h1>丸と†罰†</h1>
    <div id="board"></div>
    <div id="start" class="btn active">start</div>
    <script>
        (function() {
            "use strict";

            // game は round の繰り返し

            const startBtn = document.getElementById("start");
            const TIME_LIMIT = 10000;   // msec;
            const TIME_WAIT = 100;      // ラウンドの結果を一時的に表示する時間の長さ
            let tid_round;

            let cnt_win = 0;    // 勝利回数

            // 盤面の状態を保持するオブジェクト
            // 盤面:
            // 0 1 2
            // 3 4 5
            // 6 7 8
            let state = {
                board: [],          // 各マスの状態
                num_empty: 0,       // 空きマスの数
                running: false,     // ゲームが進行中ならばtrue
            };

            (function init() {
                // 盤面自体を生成
                let board = "<table>";
                for (let i = 0; i < 9; ++i) {
                    if (i % 3 == 0) board += "<tr>";
                    board += "<td><div id=" + i + "></div></td>";
                    if (i % 3 == 2) board += "</tr>";
                }
                board += "</table>";
                document.getElementById("board").innerHTML = board;

                // 各マスに、クリックされたときのEventListenerをつける
                for (let i = 0; i < 9; ++i) {
                    const box = document.getElementById(i);
                    box.addEventListener('click', function() {
                        if (!state.running) return;
                        // 書き込みに成功したら次の処理へ
                        if (setState(i, "o"))
                            nxtTurn();
                    });
                }

                // 盤面の初期化
                clearBoard();

                // startボタンにイベントリスナーをつける
                document.getElementById('start').addEventListener('click', function() {
                    // btn が inactive の時は押しちゃダメ
                    if (state.running) return;
                    clearBoard();
                    changeRunning(true);
                    // TIME_LIMITミリ秒経過したら終了
                    setTimeout(function() {
                        clearTimeout(tid_round);    // 結果の一時表示中なら盤面は消さない
                        finishGame();
                    }, TIME_LIMIT);
                });
            })();

            function clearBoard() {
                // 盤面をまっさらにする
                for (let i = 0; i < 9; ++i)
                    setState(i, "");
                // 検証用
                if (state.num_empty !== 9)
                    console.log("!!num_empty is wrong!!");
            }

            // runningの状態をvalにする
            function changeRunning(val) {
                state.running = val;
                startBtn.className = state.running ? "btn inactive" : "btn active";
            }

            // 位置iに文字chrを書き込む
            // 書き込みに成功したらtrueを返す
            function setState(i, chr) {
                // 空でないマスに空文字以外を書き込もうとしたらアウト
                if (chr !== "" && state.board[i] !== "")
                    return false;
                if (chr === "" && state.board[i] !== "")
                    state.num_empty++;
                if (chr !== "" && state.board[i] === "")
                    state.num_empty--;

                state.board[i] = chr;
                const box = document.getElementById(i);
                box.className = "box " + (chr === "" ? "empty" : chr);
                box.innerHTML = chr;
                return true;
            }

            function nxtTurn() {
                if (checkWins("o")) {
                    finishRound("o");
                    return;
                } else if (state.num_empty === 0) {
                    // 勝敗が決まらないまますべてのマスが埋まったら引き分け
                    finishRound("");
                    return;
                }
                playBatsu();
                if (checkWins("x")) {
                    finishRound("x");
                    return;
                }
            }

            function playBatsu() {
                // 空いてるとこにランダムに置くだけ
                while (true) {
                    let i = Math.floor(Math.random() * 9);
                    // 書き込みに成功したら次の処理へ
                    if (setState(i, "x"))
                        return;
                }
            }

            function checkWins(player) {
                const lines = [
                    [0, 1, 2],
                    [3, 4, 5],
                    [6, 7, 8],
                    [0, 3, 6],
                    [1, 4, 7],
                    [2, 5, 8],
                    [0, 4, 8],
                    [2, 4, 6]
                ];
                // タテ・ヨコ・ナナメのどれかに3つ自分の駒がそろっていれば勝ち
                for (let i = 0; i < lines.length; ++i) {
                    if (checkLine(lines[i], player)) {
                        paintLine(lines[i]);
                        return true;
                    }
                }
                return false;
            }

            // line上にplayerのコマが揃っていればtrue
            function checkLine(line, player) {
                for (let j = 0; j < line.length; ++j) {
                    if (state.board[line[j]] !== player)
                        return false;
                }
                return true;
            }

            // line上をplayerに対応した色で塗る
            function paintLine(line, player) {
                line.forEach(function(pos) {
                    document.getElementById(pos).className += " line";
                });
            }

            function finishRound(winner) {
                state.running = false;
                console.log(winner === "" ? "draw" : winner + " wins!");
                tid_round = setTimeout(function() {
                    clearBoard();
                    state.running = true;
                }, TIME_WAIT);
            }

            function finishGame() {
                console.log("Time Up!");
                changeRunning(false);
            }

        })();
    </script>
</body>
</html>
