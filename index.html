<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf8">
    <title>丸と†罰†</title>
    <link rel="stylesheet" href="mystyle.css">
</head>
<body>
    <h1>丸と†罰†</h1>
    <div id="board"></div>
    <script>
        (function() {
            "use strict";

            makeBoard();
            let num_empty = 9;

            function makeBoard() {
                // 盤面自体を生成
                let board = "<table>";
                for (let i = 0; i < 9; ++i) {
                    if (i % 3 == 0) board += "<tr>";
                    board += "<td><div id=" + i + " class=\"box empty\"></div></td>";
                    if (i % 3 == 2) board += "</tr>";
                }
                board += "</table>";
                document.getElementById("board").innerHTML = board;

                // 各マスに、クリックされたときのEventListenerをつける
                for (let i = 0; i < 9; ++i) {
                    let box = document.getElementById(i);
                    box.addEventListener('click', function() {
                        if (box.className !== "box empty") return;
                        box.className = "box maru";
                        box.innerHTML = "o";
                        --num_empty;
                        nxtTurn();
                    });
                }
            }

            function nxtTurn() {
                console.log(num_empty);
                if (checkWins("o")) {
                    finishGame("maru wins!");
                    return;
                } else if (num_empty === 0) {
                    // 勝敗が決まらないまますべてのマスが埋まったら引き分け
                    finishGame("draw");
                    return;
                }
                playBatsu();
                if (checkWins("x")) {
                    finishGame("batsu wins...");
                    return;
                }
            }

            function playBatsu() {
                // 空いてるとこにランダムに置くだけ
                while (true) {
                    let i = Math.floor(Math.random() * 9);
                    let box = document.getElementById(i);
                    if (box.className === "box empty") {
                        box.className = "box batsu";
                        box.innerHTML = "x";
                        --num_empty;
                        return;
                    }
                }
            }

            function checkWins(player) {
                let a = []; // 各マスの状態を持つ配列
                for (let i = 0; i < 9; ++i) {
                    a.push(document.getElementById(i).innerHTML);
                }
                console.log(a);
                // タテ・ヨコ・ナナメのどれかに3つ自分の駒がそろっていれば勝ち
                if (a[0] === player && a[0] === a[1] && a[0] === a[2]) return true;
                if (a[3] === player && a[3] === a[4] && a[3] === a[5]) return true;
                if (a[6] === player && a[6] === a[7] && a[6] === a[8]) return true;
                if (a[0] === player && a[0] === a[3] && a[0] === a[6]) return true;
                if (a[1] === player && a[1] === a[4] && a[1] === a[7]) return true;
                if (a[2] === player && a[2] === a[5] && a[2] === a[8]) return true;
                if (a[0] === player && a[0] === a[4] && a[0] === a[8]) return true;
                if (a[2] === player && a[2] === a[4] && a[2] === a[6]) return true;
                return false;
            }

            function finishGame(result) {
                console.log(result);
                // initBoard();
            }

            function initBoard() {
                // 盤面をまっさらにする
                for (let i = 0; i < 9; ++i) {
                    let box = document.getElementById(i);
                    box.className = "box empty";
                    box.innerHTML = "";
                }
                num_empty = 9;
            }

        })();
    </script>
</body>
</html>
